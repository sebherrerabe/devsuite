---
name: pr-review-artifact-persistence
description: Implement PR review storage and persistence in DevSuite. Handle MCP tool for submitting reviews, Convex functions for storage, company scoping, and UI integration. Use when building PR review history, storing review artifacts, or integrating review data from MCP tools.
---

# PR Review Artifact Persistence (DevSuite)

## Intent
This skill covers storing PR review artifacts generated by AI agents via MCP tools. Reviews are durable records that link to repositories, sessions, and projects. The MCP server generates reviews; this module handles persistence and presentation.

## Non-Goals
- PR review generation logic (MCP server responsibility)
- Review UI implementation (covered by frontend skills)
- GitHub PR fetching (covered by `github-cli-integration`)
- Review analysis or signal extraction (MCP server responsibility)

## Inputs to Read First
- Repo: `projects/10-pr-review-module/PROJECT.md`, `projects/05-repository-module/PROJECT.md`, `/dev_suite_conceptual_architecture_business_vs_tech.md` (section 2.9)
- Convex patterns: `projects/02-convex-foundation/PROJECT.md`
- MCP integration: `projects/09-mcp-server/PROJECT.md`

## Workflow

### 1) Data Model Design
Design Convex schema for PR reviews:
- **Required fields**: `_id`, `_creationTime`, `companyId`, `repositoryId`, `prNumber`, `prUrl`, `reviewContent`
- **Optional fields**: `sessionId`, `taskId`, `metadata` (signals, risk areas, etc.), `reviewer` (human/agent)
- **Constraints**: Company scoping, no deletion (soft delete only if needed)
- **Indexes**: By company, repository, date, session

### 2) Convex Functions Implementation
Create these Convex functions:

**storePRReview** (mutation):
- Input: `companyId`, `repositoryId`, `prNumber`, `prUrl`, `reviewContent`, `metadata?`, `sessionId?`, `taskId?`
- Validates company scoping
- Stores review as immutable record
- Returns review ID

**listPRReviews** (query):
- Input: `companyId`, filters: `repositoryId?`, `startDate?`, `endDate?`, `sessionId?`
- Returns paginated list of reviews
- Scoped by company

**getPRReview** (query):
- Input: `companyId`, `reviewId`
- Returns single review with full content
- Validates company access

### 3) MCP Tool: submitPRReview
Create MCP tool that receives review data:
- **Tool name**: `submitPRReview`
- **Input schema**:
  - `companyId` (required): Company scoping
  - `repositoryId` (required): Repository reference
  - `prNumber` (required): PR number
  - `prUrl` (required): GitHub PR URL
  - `reviewContent` (required): Markdown review content
  - `metadata` (optional): Structured signals/risk areas
  - `sessionId` (optional): Link to session
  - `taskId` (optional): Link to task
- **Behavior**: Calls Convex `storePRReview` mutation
- **Returns**: Review ID and confirmation

### 4) Company Scoping Enforcement
- All queries require `companyId`
- Validate company exists and user has access
- Filter results by company in all queries
- Return 403 if company access denied

### 5) No-Delete Enforcement
- Reviews are immutable once stored
- No delete mutation provided
- If updates needed, create new review version (future enhancement)
- Document immutability in function comments

### 6) Link Generation
- Generate GitHub links: `https://github.com/{owner}/{repo}/pull/{number}`
- Store both `prUrl` (full URL) and parsed components (owner, repo, number)
- Use stored URL for linking, parsed components for filtering

### 7) Metadata Handling
- Accept flexible `metadata` object (JSON)
- Common fields: `riskAreas`, `signals`, `reviewerType`, `duration`
- Don't enforce strict schema (MCP server controls structure)
- Store as-is for flexibility

### 8) Session/Task Correlation
- Optional `sessionId` and `taskId` fields
- Allow linking reviews to work sessions
- Support filtering by session/task
- Don't require links (reviews can be standalone)

### 9) Integration Points
- **MCP server**: Calls `submitPRReview` tool
- **Frontend**: Queries `listPRReviews` and `getPRReview`
- **GitHub integration**: Uses repository info for filtering
- **Session module**: Optional correlation via `sessionId`

## Deliverables Checklist
- [ ] Convex schema defined for PR reviews
- [ ] `storePRReview` mutation implemented and tested
- [ ] `listPRReviews` query implemented with filtering
- [ ] `getPRReview` query implemented
- [ ] Company scoping enforced on all functions
- [ ] No-delete enforcement (no delete mutation)
- [ ] MCP tool `submitPRReview` implemented
- [ ] Link generation working (GitHub URLs)
- [ ] Metadata storage flexible and working
- [ ] Session/task correlation supported
- [ ] Functions tested with valid/invalid inputs

## Schema Pattern

```typescript
// Convex schema (convex/schema.ts)
prReviews: defineTable({
  companyId: v.id("companies"),
  repositoryId: v.id("repositories"),
  prNumber: v.number(),
  prUrl: v.string(),
  reviewContent: v.string(), // Markdown
  metadata: v.optional(v.any()), // Flexible JSON
  sessionId: v.optional(v.id("sessions")),
  taskId: v.optional(v.id("tasks")),
  reviewer: v.optional(v.string()), // "human" | "agent"
})
  .index("by_company", ["companyId"])
  .index("by_repository", ["repositoryId"])
  .index("by_session", ["sessionId"])
  .index("by_company_date", ["companyId", "_creationTime"]),
```

## MCP Tool Schema Pattern

```typescript
const submitPRReviewSchema = z.object({
  companyId: z.string().describe("Company ID for scoping"),
  repositoryId: z.string().describe("Repository ID (from DevSuite)"),
  prNumber: z.number().int().positive().describe("GitHub PR number"),
  prUrl: z.string().url().describe("Full GitHub PR URL"),
  reviewContent: z.string().min(1).describe("Review content (Markdown)"),
  metadata: z.record(z.any()).optional().describe("Optional structured metadata (signals, risk areas, etc.)"),
  sessionId: z.string().optional().describe("Optional session ID to link review to work session"),
  taskId: z.string().optional().describe("Optional task ID to link review to task"),
});
```

## Convex Function Patterns

### Store Review (Mutation)
```typescript
export const storePRReview = mutation({
  args: {
    companyId: v.id("companies"),
    repositoryId: v.id("repositories"),
    prNumber: v.number(),
    prUrl: v.string(),
    reviewContent: v.string(),
    metadata: v.optional(v.any()),
    sessionId: v.optional(v.id("sessions")),
    taskId: v.optional(v.id("tasks")),
  },
  handler: async (ctx, args) => {
    // Validate company access
    // Store review
    // Return ID
  },
});
```

### List Reviews (Query)
```typescript
export const listPRReviews = query({
  args: {
    companyId: v.id("companies"),
    repositoryId: v.optional(v.id("repositories")),
    startDate: v.optional(v.number()),
    endDate: v.optional(v.number()),
    limit: v.optional(v.number()),
  },
  handler: async (ctx, args) => {
    // Validate company access
    // Build query with filters
    // Return paginated results
  },
});
```

## References
- PR Review Module: `projects/10-pr-review-module/PROJECT.md`
- Architecture Spec: `/dev_suite_conceptual_architecture_business_vs_tech.md` (section 2.9)
- Convex Foundation: `projects/02-convex-foundation/PROJECT.md`
- MCP Server: `projects/09-mcp-server/PROJECT.md`
